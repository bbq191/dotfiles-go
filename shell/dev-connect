#!/bin/bash
# æ•°æ®åº“è¿æ¥å¿«æ·è„šæœ¬

# å·¥å…·å‡½æ•°
log_info() {
    echo "$(date '+%H:%M:%S') [INFO] $1"
}

log_error() {
    echo "$(date '+%H:%M:%S') [ERROR] $1" >&2
}

# æœåŠ¡å¯ç”¨æ€§æ£€æŸ¥
check_service_available() {
    local service=$1
    local port=$2
    local host=${3:-127.0.0.1}
    
    if ! nc -z "$host" "$port" 2>/dev/null; then
        log_error "$service æœåŠ¡ä¸å¯ç”¨ (ç«¯å£ $port)"
        log_info "è¯·å…ˆè¿è¡Œ: dev-services $service"
        return 1
    fi
    return 0
}

# é…ç½®æ–‡ä»¶æ£€æŸ¥
check_config() {
    local config_file=$1
    local service=$2
    
    if [[ ! -f "$config_file" ]]; then
        log_error "$service é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $config_file"
        return 1
    fi
    return 0
}

connect_postgresql() {
    log_info "è¿æ¥åˆ° PostgreSQL..."
    
    # æ£€æŸ¥æœåŠ¡å¯ç”¨æ€§
    if ! check_service_available "PostgreSQL" 5432; then
        return 1
    fi
    
    # æ¸…ç©ºä¼šå¯¼è‡´é—®é¢˜çš„ç¯å¢ƒå˜é‡
    unset PGOPTIONS
    
    # è¿æ¥æµ‹è¯•
    if ! pg_isready -h /tmp -p 5432 >/dev/null 2>&1; then
        log_error "PostgreSQL æœåŠ¡æœªå°±ç»ª"
        return 1
    fi
    
    log_info "å·²è¿æ¥åˆ° PostgreSQL"
    PGUSER=afu PGDATABASE=postgres PGHOST=/tmp psql
}

connect_mysql() {
    log_info "è¿æ¥åˆ° MySQL..."
    
    # æ£€æŸ¥é…ç½®æ–‡ä»¶
    if ! check_config "$HOME/.config/mysql/my.cnf" "MySQL"; then
        return 1
    fi
    
    # æ£€æŸ¥æœåŠ¡å¯ç”¨æ€§
    if ! check_service_available "MySQL" 3306; then
        return 1
    fi
    
    # è¿æ¥æµ‹è¯•
    if ! mysqladmin --defaults-file="$HOME/.config/mysql/my.cnf" ping >/dev/null 2>&1; then
        log_error "MySQL æœåŠ¡æœªå°±ç»ª"
        return 1
    fi
    
    log_info "å·²è¿æ¥åˆ° MySQL"
    mysql --defaults-file="$HOME/.config/mysql/my.cnf" -h localhost -P 3306
}

connect_valkey() {
    log_info "è¿æ¥åˆ° Valkey..."
    
    # æ£€æŸ¥æœåŠ¡å¯ç”¨æ€§
    if ! check_service_available "Valkey" 6379; then
        return 1
    fi
    
    # è¿æ¥æµ‹è¯•
    if ! valkey-cli -p 6379 -a dev2024 ping >/dev/null 2>&1; then
        log_error "Valkey æœåŠ¡æœªå°±ç»ªæˆ–å¯†ç é”™è¯¯"
        return 1
    fi
    
    log_info "å·²è¿æ¥åˆ° Valkey"
    valkey-cli -h 127.0.0.1 -p 6379 -a dev2024
}

connect_ollama() {
    log_info "è¿æ¥åˆ° Ollama..."
    
    # æ£€æŸ¥æœåŠ¡å¯ç”¨æ€§
    if ! check_service_available "Ollama" 11434; then
        return 1
    fi
    
    # API æµ‹è¯•
    log_info "æµ‹è¯• Ollama API..."
    if response=$(curl -s --connect-timeout 5 http://127.0.0.1:11434/api/tags 2>/dev/null); then
        if command -v jq >/dev/null 2>&1; then
            echo "$response" | jq '.'
        else
            echo "$response"
        fi
        log_info "Ollama API è¿æ¥æˆåŠŸ"
    else
        log_error "Ollama API è¿æ¥å¤±è´¥"
        return 1
    fi
}

# æµ‹è¯•æ¨¡å¼
test_connections() {
    log_info "æµ‹è¯•æ‰€æœ‰æœåŠ¡è¿æ¥..."
    echo ""
    
    echo "ğŸ“‹ è¿æ¥æµ‹è¯•ç»“æœ:"
    
    # PostgreSQL
    if check_service_available "PostgreSQL" 5432 >/dev/null 2>&1 && \
       pg_isready -h /tmp -p 5432 >/dev/null 2>&1; then
        echo "âœ… PostgreSQL: å¯è¿æ¥"
    else
        echo "âŒ PostgreSQL: ä¸å¯è¿æ¥"
    fi
    
    # MySQL
    if check_service_available "MySQL" 3306 >/dev/null 2>&1 && \
       [[ -f "$HOME/.config/mysql/my.cnf" ]] && \
       mysqladmin --defaults-file="$HOME/.config/mysql/my.cnf" ping >/dev/null 2>&1; then
        echo "âœ… MySQL: å¯è¿æ¥"
    else
        echo "âŒ MySQL: ä¸å¯è¿æ¥"
    fi
    
    # Valkey
    if check_service_available "Valkey" 6379 >/dev/null 2>&1 && \
       valkey-cli -p 6379 -a dev2024 ping >/dev/null 2>&1; then
        echo "âœ… Valkey: å¯è¿æ¥"
    else
        echo "âŒ Valkey: ä¸å¯è¿æ¥"
    fi
    
    # Ollama
    if check_service_available "Ollama" 11434 >/dev/null 2>&1 && \
       curl -s --connect-timeout 3 http://127.0.0.1:11434/api/tags >/dev/null 2>&1; then
        echo "âœ… Ollama: å¯è¿æ¥"
    else
        echo "âŒ Ollama: ä¸å¯è¿æ¥"
    fi
}

case "$1" in
    pg|postgresql)
        connect_postgresql
        ;;
    mysql|mariadb)
        connect_mysql
        ;;
    valkey|redis)
        connect_valkey
        ;;
    ollama)
        connect_ollama
        ;;
    test)
        test_connections
        ;;
    *)
        echo "ç”¨æ³•: $0 {pg|mysql|valkey|ollama|test}"
        echo ""
        echo "è¿æ¥æœåŠ¡: pg, mysql, valkey, ollama"
        echo "æµ‹è¯•è¿æ¥: test"
        echo ""
        echo "å¿«æ·è¿æ¥åˆ°å¯¹åº”çš„å¼€å‘æœåŠ¡"
        ;;
esac