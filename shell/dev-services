#!/bin/bash
# å¼€å‘æœåŠ¡ç®¡ç†è„šæœ¬ - æ€§èƒ½ä¼˜åŒ– + åå°è¿è¡Œ

PGDATA="$HOME/.local/share/postgresql"
MYSQL_DATA="$HOME/.local/share/mysql"
VALKEY_DATA="$HOME/.local/share/valkey"
OLLAMA_DATA="$HOME/.local/share/ollama"
PID_DIR="$HOME/.local/share/pids"

# åˆ›å»ºå¿…è¦ç›®å½•
mkdir -p "$PGDATA" "$MYSQL_DATA" "$VALKEY_DATA" "$OLLAMA_DATA" "$PID_DIR"
mkdir -p "$HOME/.cache/"{postgresql,mysql,valkey,ollama}

# å·¥å…·å‡½æ•°
log_info() {
    echo "$(date '+%H:%M:%S') [INFO] $1"
}

log_error() {
    echo "$(date '+%H:%M:%S') [ERROR] $1" >&2
}

# å¥åº·æ£€æŸ¥å‡½æ•°
wait_for_postgresql() {
    log_info "ç­‰å¾… PostgreSQL å°±ç»ª..."
    for i in {1..15}; do
        if pg_isready -h /tmp -p 5432 >/dev/null 2>&1; then
            return 0
        fi
        sleep 1
    done
    return 1
}

wait_for_mysql() {
    log_info "ç­‰å¾… MySQL å°±ç»ª..."
    for i in {1..20}; do
        if mysqladmin --defaults-file="$HOME/.config/mysql/my.cnf" ping >/dev/null 2>&1; then
            return 0
        fi
        sleep 1
    done
    return 1
}

wait_for_valkey() {
    log_info "ç­‰å¾… Valkey å°±ç»ª..."
    for i in {1..10}; do
        if valkey-cli -p 6379 -a dev2024 ping >/dev/null 2>&1; then
            return 0
        fi
        sleep 1
    done
    return 1
}

wait_for_ollama() {
    log_info "ç­‰å¾… Ollama å°±ç»ª..."
    for i in {1..15}; do
        if curl -s http://127.0.0.1:11434/api/tags >/dev/null 2>&1; then
            return 0
        fi
        sleep 1
    done
    return 1
}

# é…ç½®éªŒè¯å‡½æ•°
validate_configs() {
    local errors=0
    
    # æ£€æŸ¥ MySQL é…ç½®
    if [[ ! -f "$HOME/.config/mysql/my.cnf" ]]; then
        log_error "MySQL é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $HOME/.config/mysql/my.cnf"
        errors=$((errors + 1))
    fi
    
    # æ£€æŸ¥ Valkey é…ç½®
    if [[ ! -f "$HOME/.config/valkey/valkey.conf" ]]; then
        log_error "Valkey é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $HOME/.config/valkey/valkey.conf"
        errors=$((errors + 1))
    fi
    
    # æ£€æŸ¥ Ollama é…ç½®
    if [[ ! -f "$HOME/.config/ollama/config.env" ]]; then
        log_error "Ollama é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $HOME/.config/ollama/config.env"
        errors=$((errors + 1))
    fi
    
    return $errors
}

# ç«¯å£æ£€æŸ¥å‡½æ•°
check_port() {
    local port=$1
    local service=$2
    
    if ss -tlnp | grep ":$port " >/dev/null 2>&1; then
        log_error "$service ç«¯å£ $port å·²è¢«å ç”¨"
        return 1
    fi
    return 0
}

# è¿›ç¨‹æ£€æµ‹ä¼˜åŒ–å‡½æ•°
is_postgres_running() {
    [[ -f "$PID_DIR/postgresql.pid" ]] && kill -0 "$(cat "$PID_DIR/postgresql.pid")" 2>/dev/null
}

is_mysql_running() {
    [[ -f "$PID_DIR/mysql.pid" ]] && kill -0 "$(cat "$PID_DIR/mysql.pid")" 2>/dev/null
}

is_valkey_running() {
    [[ -f "$PID_DIR/valkey.pid" ]] && kill -0 "$(cat "$PID_DIR/valkey.pid")" 2>/dev/null
}

is_ollama_running() {
    [[ -f "$PID_DIR/ollama.pid" ]] && kill -0 "$(cat "$PID_DIR/ollama.pid")" 2>/dev/null
}

start_postgresql() {
    if is_postgres_running; then
        log_info "PostgreSQL å·²åœ¨è¿è¡Œ"
        return 0
    fi
    
    # æ£€æŸ¥ç«¯å£
    if ! check_port 5432 "PostgreSQL"; then
        return 1
    fi
    
    log_info "å¯åŠ¨ PostgreSQL..."
    
    # åˆå§‹åŒ–æ•°æ®åº“(ä»…é¦–æ¬¡)
    if [[ ! -f "$PGDATA/PG_VERSION" ]]; then
        log_info "åˆå§‹åŒ– PostgreSQL æ•°æ®åº“..."
        if ! initdb -D "$PGDATA" >/dev/null 2>&1; then
            log_error "PostgreSQL æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥"
            return 1
        fi
    fi
    
    # å¯åŠ¨æœåŠ¡
    postgres -D "$PGDATA" > "$HOME/.cache/postgresql/postgres.log" 2>&1 &
    local pid=$!
    echo $pid > "$PID_DIR/postgresql.pid"
    
    # å¥åº·æ£€æŸ¥
    if wait_for_postgresql; then
        log_info "âœ… PostgreSQL å·²å¯åŠ¨ (ç«¯å£ 5432)"
        return 0
    else
        log_error "PostgreSQL å¯åŠ¨å¤±è´¥æˆ–è¶…æ—¶"
        rm -f "$PID_DIR/postgresql.pid"
        return 1
    fi
}

start_mysql() {
    if is_mysql_running; then
        log_info "MySQL å·²åœ¨è¿è¡Œ"
        return 0
    fi
    
    # éªŒè¯é…ç½®
    if [[ ! -f "$HOME/.config/mysql/my.cnf" ]]; then
        log_error "MySQL é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $HOME/.config/mysql/my.cnf"
        return 1
    fi
    
    # æ£€æŸ¥ç«¯å£
    if ! check_port 3306 "MySQL"; then
        return 1
    fi
    
    log_info "å¯åŠ¨ MySQL/MariaDB..."
    
    # åˆå§‹åŒ–æ•°æ®åº“(ä»…é¦–æ¬¡)
    if [[ ! -d "$MYSQL_DATA/mysql" ]]; then
        log_info "åˆå§‹åŒ– MySQL æ•°æ®åº“..."
        if ! mysql_install_db --user=afu --datadir="$MYSQL_DATA" >/dev/null 2>&1; then
            log_error "MySQL æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥"
            return 1
        fi
    fi
    
    # å¯åŠ¨æœåŠ¡
    mysqld --defaults-file="$HOME/.config/mysql/my.cnf" \
           > "$HOME/.cache/mysql/mysql.log" 2>&1 &
    local pid=$!
    echo $pid > "$PID_DIR/mysql.pid"
    
    # å¥åº·æ£€æŸ¥
    if wait_for_mysql; then
        log_info "âœ… MySQL å·²å¯åŠ¨ (ç«¯å£ 3306)"
        return 0
    else
        log_error "MySQL å¯åŠ¨å¤±è´¥æˆ–è¶…æ—¶"
        rm -f "$PID_DIR/mysql.pid"
        return 1
    fi
}

start_valkey() {
    if is_valkey_running; then
        log_info "Valkey å·²åœ¨è¿è¡Œ"
        return 0
    fi
    
    # éªŒè¯é…ç½®
    if [[ ! -f "$HOME/.config/valkey/valkey.conf" ]]; then
        log_error "Valkey é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $HOME/.config/valkey/valkey.conf"
        return 1
    fi
    
    # æ£€æŸ¥ç«¯å£
    if ! check_port 6379 "Valkey"; then
        return 1
    fi
    
    log_info "å¯åŠ¨ Valkey..."
    
    # å¯åŠ¨æœåŠ¡
    valkey-server "$HOME/.config/valkey/valkey.conf" \
                 > "$HOME/.cache/valkey/valkey.log" 2>&1 &
    local pid=$!
    echo $pid > "$PID_DIR/valkey.pid"
    
    # å¥åº·æ£€æŸ¥
    if wait_for_valkey; then
        log_info "âœ… Valkey å·²å¯åŠ¨ (ç«¯å£ 6379)"
        return 0
    else
        log_error "Valkey å¯åŠ¨å¤±è´¥æˆ–è¶…æ—¶"
        rm -f "$PID_DIR/valkey.pid"
        return 1
    fi
}

start_ollama() {
    if is_ollama_running; then
        log_info "Ollama å·²åœ¨è¿è¡Œ"
        return 0
    fi
    
    # éªŒè¯é…ç½®
    if [[ ! -f "$HOME/.config/ollama/config.env" ]]; then
        log_error "Ollama é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $HOME/.config/ollama/config.env"
        return 1
    fi
    
    # æ£€æŸ¥ç«¯å£
    if ! check_port 11434 "Ollama"; then
        return 1
    fi
    
    log_info "å¯åŠ¨ Ollama..."
    
    # åŠ è½½ç¯å¢ƒå˜é‡
    set -a; source "$HOME/.config/ollama/config.env"; set +a
    
    # å¯åŠ¨æœåŠ¡
    ollama serve > "$HOME/.cache/ollama/ollama.log" 2>&1 &
    local pid=$!
    echo $pid > "$PID_DIR/ollama.pid"
    
    # å¥åº·æ£€æŸ¥
    if wait_for_ollama; then
        log_info "âœ… Ollama å·²å¯åŠ¨ (ç«¯å£ 11434)"
        return 0
    else
        log_error "Ollama å¯åŠ¨å¤±è´¥æˆ–è¶…æ—¶"
        rm -f "$PID_DIR/ollama.pid"
        return 1
    fi
}

stop_postgresql_only() {
    if ! is_postgres_running; then
        log_info "PostgreSQL æœªåœ¨è¿è¡Œ"
        return 0
    fi
    
    log_info "åœæ­¢ PostgreSQL..."
    
    if pg_ctl -D "$PGDATA" stop -m fast >/dev/null 2>&1; then
        rm -f "$PID_DIR/postgresql.pid"
        log_info "âœ… PostgreSQL å·²åœæ­¢"
        return 0
    else
        log_error "PostgreSQL åœæ­¢å¤±è´¥"
        return 1
    fi
}

stop_mysql_only() {
    if ! is_mysql_running; then
        log_info "MySQL æœªåœ¨è¿è¡Œ"
        return 0
    fi
    
    log_info "åœæ­¢ MySQL..."
    
    if mysqladmin --defaults-file="$HOME/.config/mysql/my.cnf" shutdown 2>/dev/null; then
        rm -f "$PID_DIR/mysql.pid"
        log_info "âœ… MySQL å·²åœæ­¢"
        return 0
    else
        log_error "MySQL åœæ­¢å¤±è´¥"
        return 1
    fi
}

stop_valkey_only() {
    if ! is_valkey_running; then
        log_info "Valkey æœªåœ¨è¿è¡Œ"
        return 0
    fi
    
    log_info "åœæ­¢ Valkey..."
    
    if valkey-cli -a dev2024 shutdown 2>/dev/null || pkill -f "valkey-server" 2>/dev/null; then
        rm -f "$PID_DIR/valkey.pid"
        log_info "âœ… Valkey å·²åœæ­¢"
        return 0
    else
        log_error "Valkey åœæ­¢å¤±è´¥"
        return 1
    fi
}

stop_ollama_only() {
    if ! is_ollama_running; then
        log_info "Ollama æœªåœ¨è¿è¡Œ"
        return 0
    fi
    
    log_info "åœæ­¢ Ollama..."
    
    # å°è¯•ä¼˜é›…åœæ­¢ï¼Œå¦‚æœå¤±è´¥åˆ™ä½¿ç”¨ sudo
    if pkill -f ollama 2>/dev/null || sudo pkill -f ollama 2>/dev/null; then
        rm -f "$PID_DIR/ollama.pid"
        log_info "âœ… Ollama å·²åœæ­¢"
        return 0
    else
        log_error "Ollama åœæ­¢å¤±è´¥ï¼ˆæƒé™ä¸è¶³ï¼‰"
        return 1
    fi
}

stop_services() {
    log_info "åœæ­¢æ‰€æœ‰å¼€å‘æœåŠ¡..."
    local failed=0
    
    # åœæ­¢æ‰€æœ‰æœåŠ¡
    stop_postgresql_only || failed=$((failed + 1))
    stop_mysql_only || failed=$((failed + 1))
    stop_valkey_only || failed=$((failed + 1))
    stop_ollama_only || failed=$((failed + 1))
    
    if [[ $failed -eq 0 ]]; then
        log_info "âœ… æ‰€æœ‰æœåŠ¡å·²åœæ­¢"
    else
        log_error "$failed ä¸ªæœåŠ¡åœæ­¢å¤±è´¥"
        return 1
    fi
}

# å•ä¸ªæœåŠ¡é‡å¯å‡½æ•°
restart_postgresql() {
    log_info "é‡å¯ PostgreSQL..."
    stop_postgresql_only
    sleep 2
    start_postgresql
}

restart_mysql() {
    log_info "é‡å¯ MySQL..."
    stop_mysql_only
    sleep 2
    start_mysql
}

restart_valkey() {
    log_info "é‡å¯ Valkey..."
    stop_valkey_only
    sleep 1
    start_valkey
}

restart_ollama() {
    log_info "é‡å¯ Ollama..."
    stop_ollama_only
    sleep 2
    start_ollama
}

status_services() {
    echo "ğŸ“Š å¼€å‘æœåŠ¡çŠ¶æ€:"
    
    # PostgreSQL
    if is_postgres_running; then
        echo "âœ… PostgreSQL: è¿è¡Œä¸­ (ç«¯å£ 5432)"
    else
        echo "âŒ PostgreSQL: å·²åœæ­¢"
    fi
    
    # MySQL
    if is_mysql_running; then
        echo "âœ… MySQL: è¿è¡Œä¸­ (ç«¯å£ 3306)"
    else
        echo "âŒ MySQL: å·²åœæ­¢"
    fi
    
    # Valkey
    if is_valkey_running; then
        echo "âœ… Valkey: è¿è¡Œä¸­ (ç«¯å£ 6379)"
    else
        echo "âŒ Valkey: å·²åœæ­¢"
    fi
    
    # Ollama
    if is_ollama_running; then
        echo "âœ… Ollama: è¿è¡Œä¸­ (ç«¯å£ 11434)"
    else
        echo "âŒ Ollama: å·²åœæ­¢"
    fi
}

case "$1" in
    start)
        start_postgresql
        start_mysql
        start_valkey
        start_ollama
        echo "ğŸš€ æ‰€æœ‰å¼€å‘æœåŠ¡å·²å¯åŠ¨"
        ;;
    stop)
        stop_services
        ;;
    restart)
        stop_services
        sleep 2
        start_postgresql
        start_mysql
        start_valkey
        start_ollama
        echo "ğŸ”„ æ‰€æœ‰å¼€å‘æœåŠ¡å·²é‡å¯"
        ;;
    status)
        status_services
        ;;
    pg|postgresql)
        start_postgresql
        ;;
    mysql|mariadb)
        start_mysql
        ;;
    valkey|redis)
        start_valkey
        ;;
    ollama)
        start_ollama
        ;;
    stop-pg|stop-postgresql)
        stop_postgresql_only
        ;;
    stop-mysql|stop-mariadb)
        stop_mysql_only
        ;;
    stop-valkey|stop-redis)
        stop_valkey_only
        ;;
    stop-ollama)
        stop_ollama_only
        ;;
    restart-pg|restart-postgresql)
        restart_postgresql
        ;;
    restart-mysql|restart-mariadb)
        restart_mysql
        ;;
    restart-valkey|restart-redis)
        restart_valkey
        ;;
    restart-ollama)
        restart_ollama
        ;;
    *)
        echo "ç”¨æ³•: $0 {start|stop|restart|status|pg|mysql|valkey|ollama|stop-*|restart-*}"
        echo ""
        echo "å¯åŠ¨æœåŠ¡: start, pg, mysql, valkey, ollama"
        echo "åœæ­¢æœåŠ¡: stop, stop-pg, stop-mysql, stop-valkey, stop-ollama"
        echo "é‡å¯æœåŠ¡: restart, restart-pg, restart-mysql, restart-valkey, restart-ollama"
        echo "æŸ¥çœ‹çŠ¶æ€: status"
        exit 1
        ;;
esac
