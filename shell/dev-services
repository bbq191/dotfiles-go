#!/bin/bash
# å¼€å‘æœåŠ¡ç®¡ç†è„šæœ¬ - æ€§èƒ½ä¼˜åŒ– + åå°è¿è¡Œ

PGDATA="$HOME/.local/share/postgresql"
MYSQL_DATA="$HOME/.local/share/mysql"
VALKEY_DATA="$HOME/.local/share/valkey"
OLLAMA_DATA="$HOME/.local/share/ollama"

# åˆ›å»ºå¿…è¦ç›®å½•
mkdir -p "$PGDATA" "$MYSQL_DATA" "$VALKEY_DATA" "$OLLAMA_DATA"
mkdir -p "$HOME/.cache/"{postgresql,mysql,valkey,ollama}

start_postgresql() {
    if ! pgrep -f "postgres.*$PGDATA" > /dev/null; then
        echo "å¯åŠ¨ PostgreSQL..."
        # åˆå§‹åŒ–æ•°æ®åº“(ä»…é¦–æ¬¡)
        [ ! -f "$PGDATA/PG_VERSION" ] && initdb -D "$PGDATA" >/dev/null 2>&1
        
        # ä½¿ç”¨é»˜è®¤é…ç½®å¯åŠ¨ï¼Œé¿å…é…ç½®é—®é¢˜
        postgres -D "$PGDATA" > "$HOME/.cache/postgresql/postgres.log" 2>&1 &
        sleep 2
        echo "âœ… PostgreSQL å·²å¯åŠ¨ (ç«¯å£ 5432)"
    else
        echo "PostgreSQL å·²åœ¨è¿è¡Œ"
    fi
}

start_mysql() {
    if ! pgrep -f "mysqld.*$HOME" > /dev/null; then
        echo "å¯åŠ¨ MySQL/MariaDB..."
        # åˆå§‹åŒ–æ•°æ®åº“(ä»…é¦–æ¬¡)
        [ ! -d "$MYSQL_DATA/mysql" ] && mysql_install_db --user=afu --datadir="$MYSQL_DATA" >/dev/null 2>&1
        
        mysqld --defaults-file="$HOME/.config/mysql/my.cnf" \
               > "$HOME/.cache/mysql/mysql.log" 2>&1 &
        sleep 3
        echo "âœ… MySQL å·²å¯åŠ¨ (ç«¯å£ 3306)"
    else
        echo "MySQL å·²åœ¨è¿è¡Œ"
    fi
}

start_valkey() {
    if ! pgrep -f "valkey-server" > /dev/null; then
        echo "å¯åŠ¨ Valkey..."
        valkey-server "$HOME/.config/valkey/valkey.conf" \
                     > "$HOME/.cache/valkey/valkey.log" 2>&1 &
        sleep 1
        echo "âœ… Valkey å·²å¯åŠ¨ (ç«¯å£ 6379)"
    else
        echo "Valkey å·²åœ¨è¿è¡Œ"
    fi
}

start_ollama() {
    if ! pgrep -f ollama > /dev/null; then
        echo "å¯åŠ¨ Ollama..."
        # åŠ è½½ç¯å¢ƒå˜é‡
        set -a; source "$HOME/.config/ollama/config.env"; set +a
        
        ollama serve > "$HOME/.cache/ollama/ollama.log" 2>&1 &
        sleep 2
        echo "âœ… Ollama å·²å¯åŠ¨ (ç«¯å£ 11434)"
    else
        echo "Ollama å·²åœ¨è¿è¡Œ"
    fi
}

stop_services() {
    echo "åœæ­¢æ‰€æœ‰å¼€å‘æœåŠ¡..."
    
    # åœæ­¢ PostgreSQL
    if pgrep -f "postgres.*$PGDATA" > /dev/null; then
        pg_ctl -D "$PGDATA" stop -m fast >/dev/null 2>&1
        echo "âœ… PostgreSQL å·²åœæ­¢"
    fi
    
    # åœæ­¢ MySQL
    if pgrep -f "mysqld.*$HOME" > /dev/null; then
        mysqladmin --defaults-file="$HOME/.config/mysql/my.cnf" shutdown 2>/dev/null
        echo "âœ… MySQL å·²åœæ­¢"
    fi
    
    # åœæ­¢ Valkey
    if pgrep -f "valkey-server" > /dev/null; then
        valkey-cli -a dev2024 shutdown 2>/dev/null || pkill -f "valkey-server"
        echo "âœ… Valkey å·²åœæ­¢"
    fi
    
    # åœæ­¢ Ollama
    if pgrep -f ollama > /dev/null; then
        pkill -f ollama
        echo "âœ… Ollama å·²åœæ­¢"
    fi
}

status_services() {
    echo "ğŸ“Š å¼€å‘æœåŠ¡çŠ¶æ€:"
    
    # PostgreSQL
    if pgrep -f "postgres.*$PGDATA" > /dev/null; then
        echo "âœ… PostgreSQL: è¿è¡Œä¸­ (ç«¯å£ 5432)"
    else
        echo "âŒ PostgreSQL: å·²åœæ­¢"
    fi
    
    # MySQL
    if pgrep -f "mysqld.*$HOME" > /dev/null; then
        echo "âœ… MySQL: è¿è¡Œä¸­ (ç«¯å£ 3306)"
    else
        echo "âŒ MySQL: å·²åœæ­¢"
    fi
    
    # Valkey
    if pgrep -f "valkey-server" > /dev/null; then
        echo "âœ… Valkey: è¿è¡Œä¸­ (ç«¯å£ 6379)"
    else
        echo "âŒ Valkey: å·²åœæ­¢"
    fi
    
    # Ollama
    if pgrep -f ollama > /dev/null; then
        echo "âœ… Ollama: è¿è¡Œä¸­ (ç«¯å£ 11434)"
    else
        echo "âŒ Ollama: å·²åœæ­¢"
    fi
}

case "$1" in
    start)
        start_postgresql
        start_mysql
        start_valkey
        start_ollama
        echo "ğŸš€ æ‰€æœ‰å¼€å‘æœåŠ¡å·²å¯åŠ¨"
        ;;
    stop)
        stop_services
        ;;
    restart)
        stop_services
        sleep 2
        start_postgresql
        start_mysql
        start_valkey
        start_ollama
        echo "ğŸ”„ æ‰€æœ‰å¼€å‘æœåŠ¡å·²é‡å¯"
        ;;
    status)
        status_services
        ;;
    pg|postgresql)
        start_postgresql
        ;;
    mysql|mariadb)
        start_mysql
        ;;
    valkey|redis)
        start_valkey
        ;;
    ollama)
        start_ollama
        ;;
    *)
        echo "ç”¨æ³•: $0 {start|stop|restart|status|pg|mysql|valkey|ollama}"
        exit 1
        ;;
esac